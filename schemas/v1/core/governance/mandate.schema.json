{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raise.local/schemas/v1/core/governance/mandate.schema.json",
  "title": "Mandate Policy (Dynamic Rules)",
  "type": "object",
  "$defs": {
    "astExpression": {
      "description": "Structure recursive pour le moteur de regles (AST)",
      "oneOf": [
        {
          "title": "Primitive: Valeur",
          "type": "object",
          "properties": { "val": {} },
          "required": ["val"],
          "additionalProperties": false
        },
        {
          "title": "Primitive: Variable",
          "type": "object",
          "properties": { "var": { "type": "string" } },
          "required": ["var"],
          "additionalProperties": false
        },
        {
          "title": "Logique: Condition (If)",
          "type": "object",
          "properties": {
            "if": {
              "type": "object",
              "properties": {
                "condition": { "$ref": "#/$defs/astExpression" },
                "then_branch": { "$ref": "#/$defs/astExpression" },
                "else_branch": { "$ref": "#/$defs/astExpression" }
              },
              "required": ["condition", "then_branch", "else_branch"],
              "additionalProperties": false
            }
          },
          "required": ["if"],
          "additionalProperties": false
        },
        {
          "title": "Comparaisons & Operateurs Binaires",
          "type": "object",
          "properties": {
            "eq": { "$ref": "#/$defs/binaryOp" },
            "neq": { "$ref": "#/$defs/binaryOp" },
            "gt": { "$ref": "#/$defs/binaryOp" },
            "lt": { "$ref": "#/$defs/binaryOp" },
            "gte": { "$ref": "#/$defs/binaryOp" },
            "lte": { "$ref": "#/$defs/binaryOp" }
          },
          "minProperties": 1,
          "maxProperties": 1,
          "additionalProperties": false
        },
        {
          "title": "Operateurs Multiples (Maths & Logique)",
          "type": "object",
          "properties": {
            "and": { "$ref": "#/$defs/multiOp" },
            "or": { "$ref": "#/$defs/multiOp" },
            "add": { "$ref": "#/$defs/multiOp" },
            "sub": { "$ref": "#/$defs/multiOp" },
            "mul": { "$ref": "#/$defs/multiOp" },
            "div": { "$ref": "#/$defs/multiOp" },
            "concat": { "$ref": "#/$defs/multiOp" }
          },
          "minProperties": 1,
          "maxProperties": 1,
          "additionalProperties": false
        },
        {
          "title": "Operateurs Unaires",
          "type": "object",
          "properties": {
            "not": { "$ref": "#/$defs/astExpression" },
            "len": { "$ref": "#/$defs/astExpression" },
            "min": { "$ref": "#/$defs/astExpression" },
            "max": { "$ref": "#/$defs/astExpression" },
            "abs": { "$ref": "#/$defs/astExpression" },
            "trim": { "$ref": "#/$defs/astExpression" },
            "upper": { "$ref": "#/$defs/astExpression" },
            "lower": { "$ref": "#/$defs/astExpression" }
          },
          "minProperties": 1,
          "maxProperties": 1,
          "additionalProperties": false
        },
        {
          "title": "Fonctions Complexes",
          "type": "object",
          "properties": {
            "round": {
              "type": "object",
              "properties": {
                "value": { "$ref": "#/$defs/astExpression" },
                "precision": { "$ref": "#/$defs/astExpression" }
              },
              "required": ["value", "precision"],
              "additionalProperties": false
            },
            "contains": {
              "type": "object",
              "properties": {
                "list": { "$ref": "#/$defs/astExpression" },
                "value": { "$ref": "#/$defs/astExpression" }
              },
              "required": ["list", "value"],
              "additionalProperties": false
            },
            "regex_match": {
              "type": "object",
              "properties": {
                "value": { "$ref": "#/$defs/astExpression" },
                "pattern": { "$ref": "#/$defs/astExpression" }
              },
              "required": ["value", "pattern"],
              "additionalProperties": false
            }
          },
          "minProperties": 1,
          "maxProperties": 1,
          "additionalProperties": false
        }
      ]
    },
    "binaryOp": {
      "type": "array",
      "items": { "$ref": "#/$defs/astExpression" },
      "minItems": 2,
      "maxItems": 2
    },
    "multiOp": {
      "type": "array",
      "items": { "$ref": "#/$defs/astExpression" }
    }
  },
  "properties": {
    "meta": {
      "type": "object",
      "properties": {
        "author": { "type": "string" },
        "version": { "type": "string" },
        "status": { "type": "string" },
        "description": { "type": "string" }
      },
      "required": ["author", "version"]
    },
    "governance": {
      "type": "object",
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["SAFETY_FIRST", "PERFORMANCE", "BALANCED", "TEST"]
        },
        "condorcetWeights": {
          "type": "object",
          "additionalProperties": { "type": "number" }
        }
      },
      "required": ["strategy"]
    },
    "hardLogic": {
      "type": "object",
      "properties": {
        "vetos": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "description": { "type": "string" },
              "active": { "type": "boolean" },
              "severity": { "type": "string", "enum": ["BLOCK", "WARN"] },
              "logic": { "$ref": "#/$defs/astExpression" }
            },
            "required": ["name", "active", "logic"]
          }
        }
      },
      "required": ["vetos"]
    },
    "observability": {
      "type": "object",
      "properties": {
        "heartbeatMs": { "type": "number" },
        "metrics": { "type": "array", "items": { "type": "string" } }
      }
    },
    "signature": { "type": "string" }
  },
  "required": ["meta", "governance", "hardLogic"]
}
