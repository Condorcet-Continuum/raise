{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raise.local/schemas/v1/sandbox/scaffold.schema.json",
  "title": "Scaffold Recipe",
  "description": "Grammaire définissant une recette de génération de structure de fichiers.",
  "x_schemaVersion": "1.0.0",
  "x_label": {
    "fr": "Recette de Scaffolding",
    "en": "Scaffold Recipe"
  },
  "x_description": {
    "fr": "Définit les opérations (création dossier, écriture fichier, itération) pour générer du code.",
    "en": "Defines operations (create dir, write file, iterate) to generate code."
  },
  "type": "object",
  "allOf": [
    {
      "$ref": "../common/types/base.schema.json",
      "description": "Hérite des champs systèmes standards (id, dates, $schema)."
    }
  ],
  "properties": {
    "recipeName": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/slug",
      "description": "Identifiant unique lisible de la recette (ex: 'rust-wasm-v1')."
    },
    "description": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/nonEmptyString"
    },
    "targetRoot": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/nonEmptyString",
      "description": "Chemin racine relatif pour l'exécution (ex: 'un2/_system/workspace/moteur/{{handle}}')."
    },
    "steps": {
      "type": "array",
      "description": "Liste séquentielle des opérations à exécuter.",
      "items": {
        "$ref": "#/$defs/operation"
      },
      "minItems": 1
    }
  },
  "required": ["recipeName", "description", "targetRoot", "steps"],
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "$defs": {
    "operation": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["createDir", "writeFile", "iterate"]
        },
        "path": {
          "$ref": "../common/types/primitive-types.schema.json#/$defs/nonEmptyString"
        },
        "content": {
          "type": "string",
          "description": "Contenu ou Template Mustache (requis pour writeFile)."
        },
        "collection": {
          "$ref": "../common/types/primitive-types.schema.json#/$defs/nonEmptyString",
          "description": "Source de données pour l'itération (requis pour iterate)."
        },
        "iteratorVar": {
          "$ref": "../common/types/primitive-types.schema.json#/$defs/slug",
          "description": "Nom de la variable de boucle (requis pour iterate)."
        },
        "steps": {
          "type": "array",
          "items": { "$ref": "#/$defs/operation" },
          "description": "Sous-opérations (requis pour iterate)."
        }
      },
      "required": ["type"],
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "writeFile" } } },
          "then": { "required": ["path", "content"] }
        },
        {
          "if": { "properties": { "type": { "const": "createDir" } } },
          "then": { "required": ["path"] }
        },
        {
          "if": { "properties": { "type": { "const": "iterate" } } },
          "then": { "required": ["collection", "iteratorVar", "steps"] }
        }
      ],
      "additionalProperties": false
    }
  }
}
