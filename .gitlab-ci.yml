stages: [lint, build, test]

# Cache global simple (pas de key.files)
cache:
  key: "deps-${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
  paths:
    - target/
    - src-tauri/target/
    - .cargo/registry/
    - .pnpm-store/
    - node_modules/
  policy: pull-push

variables:
  CARGO_TERM_COLOR: always
  DEBIAN_FRONTEND: noninteractive

# Lint Rust (toléré en échec pour démarrer vite)
rust:lint:
  stage: lint
  image: rust:1
  rules:
    - exists:
        - Cargo.toml
        - src-tauri/Cargo.toml
  script:
    - |
      if [ -f Cargo.toml ]; then MANIFEST="Cargo.toml"; \
      elif [ -f src-tauri/Cargo.toml ]; then MANIFEST="src-tauri/Cargo.toml"; \
      else echo "No Cargo.toml found"; exit 0; fi
    - rustup component add rustfmt clippy || true
    - cargo fmt --manifest-path "$MANIFEST" -- --check || true
    - cargo clippy --manifest-path "$MANIFEST" -- -D warnings || true
  allow_failure: true

# Build Rust "classique" (hors Tauri) depuis la racine, si présent
rust:build:
  stage: build
  image: rust:1
  rules:
    - exists:
        - Cargo.toml
  script:
    - echo "Building root workspace"
    - cargo build --workspace --release
  artifacts:
    paths:
      - target/release/
    expire_in: 1 week

# Build Tauri (installe les libs système manquantes)
tauri:build:
  stage: build
  image: rust:1-bookworm
  rules:
    - exists:
        - src-tauri/Cargo.toml
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends
      pkg-config build-essential curl ca-certificates
      libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
      libwebkit2gtk-4.0-dev
  script:
    - echo "Building Tauri app"
    - cargo build --manifest-path src-tauri/Cargo.toml --release
  artifacts:
    paths:
      - src-tauri/target/release/
    expire_in: 1 week

# Tests Rust (si workspace racine présent)
